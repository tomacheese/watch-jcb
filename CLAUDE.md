# CLAUDE.md

## 目的
このドキュメントは、Claude Code の作業方針とプロジェクト固有ルールを示します。

## 判断記録のルール
1. 判断内容の要約を記載する
2. 検討した代替案を列挙する
3. 採用しなかった案とその理由を明記する
4. 前提条件・仮定・不確実性を明示する
5. 他エージェントによるレビュー可否を示す

## プロジェクト概要
- 目的: JCB カードのキャンペーン情報を監視し、新着情報を Discord に通知する
- 主な機能: JCB キャンペーン一覧ページのスクレイピング、新着判定、Discord 通知

## 重要ルール
- 会話は日本語で行う。
- コミットメッセージは Conventional Commits に従い、`<description>` は日本語で記載する。
- コード内のコメントは日本語で記載する。
- エラーメッセージは原則英語で記載する。

## 環境のルール
- ブランチ命名は Conventional Branch (`feat/`, `fix/` 等) に従う。
- GitHub リポジトリの調査は、必要に応じてテンポラリディレクトリに clone して行う。
- Renovate が作成した既存の PR に対して追加コミットを行わない。

## Git Worktree
Git Worktree を使用する場合、以下の構成とする：
- `.bare/` (bare リポジトリ)
- `<branch_name>/` (各ブランチの worktree)

## コード改修時のルール
- 日本語と英数字の間には半角スペースを挿入する。
- コンソール出力メッセージで絵文字が使用されている場合は、それに合わせる。
- TypeScript の `skipLibCheck` 禁止。
- 関数やインターフェースには JSDoc を英語で記載する（既存コードの慣習に従う）。

## 相談ルール
- 実装レビューや局所設計の相談は Codex CLI (グローバル CLAUDE.md で定義) に行う。
- 外部仕様や最新情報の確認は Gemini CLI に行う。
- 指摘への対応を黙殺しない。

## 開発コマンド
```bash
# インストール
pnpm install

# 開発
pnpm dev

# ビルド (型チェック)
pnpm lint:tsc

# テスト
pnpm test

# リンター
pnpm lint

# フォーマット修正
pnpm fix
```

## アーキテクチャと主要ファイル
- `src/main.ts`: エントリーポイント。設定の読み込みと実行ループの管理。
- `src/jcb-campaigns.ts`: JCB キャンペーンサイトのスクレイピングロジック。
- `src/discord.ts`: Discord への通知処理。
- `src/config.ts`: 設定の定義と読み込み。
- `src/notified.ts`: 通知済み情報の管理。
- `schema/Configuration.json`: 設定ファイルの JSON Schema。

## 実装パターン
- キャンペーン情報の取得には `cheerio` を使用。
- 文字エンコーディングの変換には `iconv-lite` を使用。
- 設定はシングルトン的に扱うのではなく、必要に応じて渡すか明示的に読み込む。

## テスト
- `jest` を使用。
- `src/jcb-campaigns.test.ts` にスクレイピングロジックのテストがある。

## ドキュメント更新ルール
- 設定構造を変更した場合は `pnpm generate-schema` を実行する。

## 作業チェックリスト

### 新規改修時
1. プロジェクトを理解する
2. 作業ブランチが適切であることを確認する
3. 最新のリモートブランチに基づいた新規ブランチであることを確認する
4. 不要ブランチが削除済みであることを確認する
5. `pnpm install` を実行する

### コミット・プッシュ前
1. Conventional Commits に従っているか確認する
2. センシティブな情報が含まれていないか確認する
3. `pnpm lint` を実行しエラーがないことを確認する
4. `pnpm test` を実行し動作確認を行う

### PR 作成前
1. PR 作成の依頼があることを確認する
2. コンフリクトの恐れがないことを確認する

### PR 作成後
1. コンフリクトがないことを確認する
2. PR 本文を日本語で最新の状態のみ網羅して記載する
3. `gh pr checks <PR ID> --watch` で CI を確認する
4. Copilot レビュー等に対応する
